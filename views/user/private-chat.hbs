<!DOCTYPE html>
<html>
<head>
  <title>Person Chat</title>
  <style>
    /* Basic styling */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
     background-color: #000814;

    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #01133c;
      position: fixed;
     top: 60px;
     
      width: 100%;
    
    }
    .content {
      background-color: #02161f;
      max-width: 300px;
      padding: 5px;
      border-radius: 10px;
      color: #325f6d;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
     
      
    }

    .profile-image {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .username {
      font-weight: bold;
      font-size: 10px;
      color: #fff;
    }

    /* Chat container */
    .chat-container {
      margin-top: 100px;  /* Adjust this value based on the height of your header */
      
    }

    /* Chat bubbles */
    .chat-bubble {
      max-width: 300px;

      margin-bottom: 15px;
      padding: 1px;
      border-radius: 10px;
      clear: both;
    }

    .sender {
      background-color: #03802f;
      color: #fff;
      float: right;
      padding-right: 13px;
    }

    .receiver {
      background-color: #ff8800;
      color: #fff;
      float: left;
      padding-left: 13px;
    }

    /* Footer */
    .footer {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #01002d;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 40px;
    }

    .message-input {
      
      margin-right: 10px;
      padding: 8px;
      border-radius: 15px;
      border: none;
      outline: none;
      background-color: #1a1a2c;
      color: #fff;
      height: 25px;
    }

    .image-input {
      display: none;
    }
    .upload-btn {
      display: none;
      position: fixed;
      right: 55px;
      bottom: 2px;
    }
    
    .upload-btn input[type="file"] {
      display: none;
    }

    .send-button {
      padding: 8px 16px;
      border-radius: 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      outline: none;
      cursor: pointer;
    }






     @media (min-width: 600px) {
      .message .content {
        flex: 0 0 calc(100% - 60px);
      }
    }
    
    .profile {
      text-align: center;
    }
    
    .profile-image {
      margin-top: 5px;
      display: inline-block;
      position: relative;
      width: 20px;
      height: 20px;
      border-radius: 5px;
      overflow: hidden;
      background-color: #000814;
      cursor: pointer;
    }
    
    .profile-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .upload-btn {
      display: none;
      position: fixed;
      right: 55px;
      bottom: 1px;
    }
    
    .upload-btn input[type="file"] {
      display: none;
    }
    
    .fixbtn {
      position: fixed;
      right: 15px;
      bottom: 7px;
      border-radius: 50%;
    }
    
    .pop {
      position: fixed;
      right: 55px;
      bottom: 2px;
      border-radius: 50%;
    }
    
    .fixbtn img {
      width: 30px;
      border-radius: 50%;
    }
    
    @media (max-width: 768px) {
      .fixbtn {
        max-width: 150px;
      }
    }
    
    @media (max-width: 480px) {
      .fixbtn {
        max-width: 100px;
      }
    }
    
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #031621;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .text {
      border-radius: 8px 3px 3px 8px;
      border: none;
      color: #fff;
      background-color: #01070c;
      flex: 1;
     padding-left: 10px;
      margin-right: 10px;
      font-size: 14px;
      max-width: 100%;
    }
    
    .send-btn {
      background-color: #042129;
      border: none;
      color: #fff;
      border-radius: 50%;
     
      cursor: pointer;
    }
    
    .send-btn img {
      width: 40px;
      height: 40px;
    }
  </style>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
</head>
<body>
  <div class="header">
    <img src="/product-images/{{userId}}.jpg" class="profile-image">
    
    <span class="username">{{userName}}</span>
     
  </div>
<div id="detailsContainer">
  
    <!-- Example chat bubbles -->
    {{#each detailsChat}}
    <div class="chat-container">
    {{#if this.sender}}
   <div class="chat-bubble sender">
        <div class="content">
            {{#if this.details.image}}
          <img src='/product-images/{{this.details._id}}.jpg' alt="Image" style="width: 270px; border-radius: 5px;">
          {{/if}}
          <p style=" color: rgb(245, 245, 245); font-size: 16px;">{{this.details.Text}}</p>
        </div>
    </div>
    {{else}}
    <div class="chat-bubble receiver">
        <div class="content">
           {{#if this.details.image}}
          <img src='/product-images/{{this.details._id}}.jpg' alt="Image" style="width: 270px; border-radius: 5px;">
          {{/if}}
          <p style=" color: rgb(245, 245, 245); font-size: 9px;">{{this.details.Text}}</p>
        </div>
    </div>
    {{/if}}
 </div>
    {{/each}}
    
   
   
  </div>

  <div class="footer">
    

    <form id="detailsForm" enctype="multipart/form-data" style="width: 100%; display: flex;">
     <input class="text" type="text" class="form-control" name="Text" placeholder="Enter something..." style="height: 25px; margin-top: 5px;">
      <label for="profile-pic" class="profile-image">
        <img src="/product-images/img.png" alt="Profile Picture" id="imageid" style="width: 18px; height: 18px;">
      </label>
      <input type="file" name="image" id="profile-pic" accept="image/*" class="upload-btn" onchange="viewimg(event)">
      
     <input type="text" name="receiverName" value="{{userName}}" hidden>
      <input type="text" name="receiverId" value="{{userId}}" hidden>
      <button type="submit" style="background-color: #021316; border: none;">
        <img src="/product-images/send.png" alt="Send" / style="width: 20px; ">
      </button>
    </form>
  </div>
</body>
<script src="/socket.io/socket.io.js"></script>

<script>
  function viewimg(event) {
    document.getElementById('imageid').src = URL.createObjectURL(event.target.files[0]);
  }

  // Create a Socket.IO client instance
  const socket = io();

  // Handle incoming chat messages
  socket.on('prirecevemessage', (newDetail) => {
    console.log(newDetail);
    // Create a new HTML element for the new detail
    var newDetailElement = document.createElement('div');
    newDetailElement.classList.add('chat-container');
    newDetailElement.innerHTML = 
      `<div class="chat-container">
    ${newDetail.sender ? `
      <div class="chat-bubble sender">
        <div class="content">
          ${newDetail.details.image ? ` <img src="/product-images/${newDetail.details._id}.jpg" alt="Image" style="width: 270px; border-radius: 5px;">`: ''}
          <p style="font-family: cursive; color: rgb(245, 245, 245); font-size: 16px;">${newDetail.details.Text}</p>
        </div>
      </div>
     `:` 
      <div class="chat-bubble receiver">
        <div class="content">
          ${newDetail.details.image ?` <img src="/product-images/${newDetail.details._id}.jpg" alt="Image" style="width: 270px; border-radius: 5px;">` : ''}
          <p style="font-family: cursive; color: rgb(245, 245, 245); font-size: 9px;">${newDetail.details.Text}</p>
        </div>
      </div>
    `}
  </div>
`;

    // Find the detailsContainer element
    var detailsContainer = document.getElementById('detailsContainer');

    // Append the new detail element to detailsContainer
    detailsContainer.insertBefore(newDetailElement, detailsContainer.firstChild);
  });

  document.getElementById('detailsForm').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent default form submission

    var formData = new FormData(this);
    var senderId = "{{user._id}}";
    var receiverId = "{{userId}}";
    fetch('/private-chat/'+receiverId, {
      method: 'POST',
      body: formData,
    })
    .then(function (response) {
      if (response.ok) {
        console.log('Form data submitted successfully for private chat');
        return response.json(); // Parse the response as JSON
      } else {
        console.error('Error submitting form data. Status:', response.status);
        throw new Error('Form data submission failed');
      }
    })
    .then(function (data) {
      console.log(data);
      // Emit the new detail to the server via Socket.IO
      socket.emit('prisendmessage', { senderId, receiverId, message: data });
    })
    .catch(function (error) {
      console.error('Error processing private chat:', error);
    })
    .finally(function () {
      // Reset the form fields
      document.getElementById('detailsForm').reset();
    });
  })
</script>
</html>

{{!-- newDetailElement.innerHTML = 
      
       `<div class="chat-container">
    ${newDetail.sender ? `
      <div class="chat-bubble sender">
        <div class="content">
          ${newDetail.details.image ? ` <img src="/product-images/${newDetail.details._id}.jpg" alt="Image" style="width: 270px; border-radius: 5px;">`: ''}
          <p style="font-family: cursive; color: rgb(245, 245, 245); font-size: 16px;">${newDetail.details.Text}</p>
        </div>
      </div>
     `:` 
      <div class="chat-bubble receiver">
        <div class="content">
          ${newDetail.details.image ?` <img src="/product-images/${newDetail.details._id}.jpg" alt="Image" style="width: 270px; border-radius: 5px;">` : ''}
          <p style="font-family: cursive; color: rgb(245, 245, 245); font-size: 9px;">${newDetail.details.Text}</p>
        </div>
      </div>
    `}
  </div>
`; --}}
